<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Weather Map Project</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
	<script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
	<link href='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet'/>
</head>
<body>
	<div class="container">
		<label for="userInput">Place <input type="text" id="userInput"></label>
		<button class="btn btn-primary" id="searchButton">Search</button>
		<div>Current Location: <span id="current"></span></div>
		<section id="forecast" class="row"></section>
		<div id='map' style='width: 100%; height: 300px;'></div>
	</div>
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
	<script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI=" crossorigin="anonymous"></script>
	<script src="js/mapbox-geocoder-utils.js"></script>
	<script src="js/keys.js"></script>
	<script>
		"use strict";
		$(document).ready(function () {
			// find the date for the forecast
			function findDate(timestamp) {
				let date = new Date(timestamp * 1000);
				return date.toDateString();
			}

			function addMarkerListeners(marker) {
				marker.getElement().addEventListener("click", function () {
					getWeatherFromCoord([marker.getLngLat().lng, marker.getLngLat().lat]);
					let locationName = "Unknown Location";
					$("#current").text(locationName);
					reverseGeocode(marker.getLngLat(), mapboxgl.accessToken).then(function (result) {
						let names = [];
						result.features.forEach(function (feature) {
							switch (feature.place_type[0]) {
								case "place":
									names.push(feature.place_name);
									break;
								case "district":
									names.push(feature.place_name);
									break;
								case "region":
									names.push(feature.place_name);
									break;
								case "country":
									names.push(feature.place_name);
							}
						});
						locationName = names[0];
						$("#current").text(locationName);
					});
				});
			}

			// use OpenWeatherMap API to find weather data of a location given by coordinates and insert to HTML
			function getWeatherFromCoord(place) {
				$.get("https://api.openweathermap.org/data/2.5/onecall", {
					appid: WEATHER_MAP_OPEN_WEATHER_APPID,
					lon: place[0],
					lat: place[1],
					units: "imperial"
				}).done(function (data) {
					let forecastSection = $("#forecast");
					forecastSection.html("");
					let fiveDays = [];
					for (let i = 0; i < 5; i++) {
						fiveDays.push(data.daily[i]);
						let column = document.createElement("div");
						column.setAttribute("class", "col");
						column.setAttribute("id", "column" + i);
						forecastSection.append(column);
						let card = document.createElement("div");
						card.setAttribute("class", "card");
						card.setAttribute("id", "day" + i);
						$("#column" + i).append(card);
						let cardBody = document.createElement("ul");
						cardBody.setAttribute("class", "list-group list-group-flush");
						$("#day" + i).append(cardBody);
					}
					fiveDays.forEach(function (forecast, index) {
						let dayList = $("#day" + index + " > .list-group");
						let forecastDate = forecast.dt;
						let dateHeader = document.createElement("div");
						dateHeader.setAttribute("class", "card-header");
						dateHeader.innerText = findDate(forecastDate);
						$("#day" + index).prepend(dateHeader);
						let dailyTemp = document.createElement("li");
						dailyTemp.setAttribute("class", "list-group-item");
						dailyTemp.innerHTML = Math.floor(forecast.temp.min) + "&#8457;" + " / " + Math.floor(forecast.temp.max) + "&#8457;";
						dayList.append(dailyTemp);
						let weatherIcon = document.createElement("img");
						weatherIcon.setAttribute("src", "http://openweathermap.org/img/wn/" + forecast.weather[0].icon + ".png");
						weatherIcon.setAttribute("style", "height: 50px; width: 50px");
						weatherIcon.setAttribute("class", "mx-auto");
						dayList.append(weatherIcon);
						let dayDescription = document.createElement("li");
						dayDescription.setAttribute("class", "list-group-item text-center");
						dayDescription.innerHTML = forecast.weather[0].description;
						dayList.append(dayDescription);
						let dailyHumidity = document.createElement("li");
						dailyHumidity.setAttribute("class", "list-group-item");
						dailyHumidity.innerHTML = "Humidity: " + forecast.humidity;
						dayList.append(dailyHumidity);
						let dailyWind = document.createElement("li");
						dailyWind.setAttribute("class", "list-group-item");
						dailyWind.innerHTML = "Wind Speed: " + forecast.wind_speed;
						dayList.append(dailyWind);
						let dailyPressure = document.createElement("li");
						dailyPressure.setAttribute("class", "list-group-item");
						dailyPressure.innerHTML = "Pressure: " + forecast.pressure;
						dayList.append(dailyPressure);
					});
					userInput.val("");
				});
			}

			// make sure the user typed something in the input box and alert them if they did not
			function checkUserInput() {
				if (!userInput.val()) {
					alert("Please input a location.");
				} else {
					getWeather(userInput.val());
				}
			}

			// translate user's input into coordinates with Mapbox API for use in OpenWeatherMap API and set a marker at that location
			function getWeather(place) {
				geocode(place, mapboxgl.accessToken).then(function (result) {
					let coordinates = [result.features[0].center[0], result.features[0].center[1]];
					let placeName = result.features[0].place_name
					$("#current").text(placeName);
					getWeatherFromCoord(coordinates);
					map.flyTo({center: coordinates});
					let marker = new mapboxgl.Marker().setLngLat(coordinates).addTo(map);
					let popup = new mapboxgl.Popup().setHTML(placeName);
					marker.setPopup(popup);
					addMarkerListeners(marker);
				});
			}

			// create map object for Mapbox API
			mapboxgl.accessToken = WEATHER_MAP_MAPBOX_KEY;
			const map = new mapboxgl.Map({
				container: 'map', // container ID
				style: 'mapbox://styles/mapbox/streets-v11', // style URL
				center: [-98.4951, 29.4246], // starting position [lng, lat]
				zoom: 10 // starting zoom
			});
			let userInput = $("#userInput");
			getWeather("San Antonio, Texas, United States");
			// check the user's input if they click the search button
			$("#searchButton").click(function () {
				checkUserInput();
			});
			// check the user's input if they press enter while typing in the input box
			userInput.on("keypress", function (e) {
				if (e.key === "Enter") {
					checkUserInput();
				}
			});
			// double-clicking a location on the map gets weather data and places a marker for that location
			map.on("dblclick", function (e) {
				let coordinates = [e.lngLat.lng, e.lngLat.lat];
				getWeatherFromCoord(coordinates);
				let marker = new mapboxgl.Marker().setLngLat(coordinates).addTo(map);
				addMarkerListeners(marker);
				let locationName = "Unknown Location";
				$("#current").text(locationName);
				reverseGeocode({
					lng: coordinates[0],
					lat: coordinates[1]
				}, mapboxgl.accessToken).then(function (result) {
					let names = [];
					result.features.forEach(function (feature) {
						switch (feature.place_type[0]) {
							case "place":
								names.push(feature.place_name);
								break;
							case "district":
								names.push(feature.place_name);
								break;
							case "region":
								names.push(feature.place_name);
								break;
							case "country":
								names.push(feature.place_name);
						}
					});
					locationName = names[0];
					if (result.features.length === 0) {
						locationName = "Unknown Location";
					}
					$("#current").text(locationName);
					let popup = new mapboxgl.Popup().setHTML(locationName);
					marker.setPopup(popup);
				});
			});
		});
	</script>
</body>
</html>